<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE FlexibleInstances #-}
<span class="lineno">    2 </span>
<span class="lineno">    3 </span>
<span class="lineno">    4 </span>{-
<span class="lineno">    5 </span>Part of chapter 3 of the raytracer challenge.
<span class="lineno">    6 </span>
<span class="lineno">    7 </span>A lot of matrix calculus comes in handy here.
<span class="lineno">    8 </span>
<span class="lineno">    9 </span>Used some references of:
<span class="lineno">   10 </span>https://semath.info/src/inverse-cofactor-ex4.html
<span class="lineno">   11 </span>https://www.wisfaq.nl/show3archive.asp?id=23989&amp;j=2004
<span class="lineno">   12 </span>-}
<span class="lineno">   13 </span>
<span class="lineno">   14 </span>module Matrices where
<span class="lineno">   15 </span>import Data.Array
<span class="lineno">   16 </span>import Tuples
<span class="lineno">   17 </span>data Matrix a = Matrix { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">getNRows</span></span></span> :: Row,
<span class="lineno">   18 </span>                         <span class="nottickedoff"><span class="decl"><span class="nottickedoff">getNCols</span></span></span> :: Column,                        
<span class="lineno">   19 </span>                         <span class="istickedoff"><span class="decl"><span class="istickedoff">getArray</span></span></span> :: Array (Row, Column) a}
<span class="lineno">   20 </span> deriving <span class="decl"><span class="nottickedoff">Show</span></span>
<span class="lineno">   21 </span>
<span class="lineno">   22 </span>    
<span class="lineno">   23 </span>
<span class="lineno">   24 </span>instance Eq (Matrix Double) where
<span class="lineno">   25 </span>    <span class="decl"><span class="nottickedoff">a == b = predicate</span>
<span class="lineno">   26 </span><span class="spaces">        </span><span class="nottickedoff">where predicate = (getNCols a) == (getNCols b) &amp;&amp; </span>
<span class="lineno">   27 </span><span class="spaces">                          </span><span class="nottickedoff">(getNRows a) == (getNRows b) &amp;&amp;</span>
<span class="lineno">   28 </span><span class="spaces">                          </span><span class="nottickedoff">(all (==True) (zipWith compare (elems (getArray a)) (elems (getArray b))))</span>
<span class="lineno">   29 </span><span class="spaces">                   </span><span class="nottickedoff">where compare a b = abs (a - b) &lt; Tuples.epsilon</span></span>
<span class="lineno">   30 </span>
<span class="lineno">   31 </span>instance (Num a, Fractional a) =&gt; Num (Matrix a) where
<span class="lineno">   32 </span>   <span class="decl"><span class="nottickedoff">a * b = listToMatrix [ celCalc a b i j | i &lt;- [0..getNRows a-1], j &lt;- [0..getNCols a-1]]</span>
<span class="lineno">   33 </span><span class="spaces">    </span><span class="nottickedoff">where check = (snd . snd . bounds . getArray)</span></span>
<span class="lineno">   34 </span>
<span class="lineno">   35 </span>instance Functor Matrix where
<span class="lineno">   36 </span>    <span class="decl"><span class="nottickedoff">fmap f m = listToMatrix (map f (elems $ getArray m))</span></span>
<span class="lineno">   37 </span>
<span class="lineno">   38 </span>instance Applicative Matrix where
<span class="lineno">   39 </span>    <span class="decl"><span class="nottickedoff">pure x = matrix 4 4 (\_ -&gt; x)</span></span>
<span class="lineno">   40 </span>    <span class="decl"><span class="nottickedoff">(&lt;*&gt;) = undefined</span></span>
<span class="lineno">   41 </span>
<span class="lineno">   42 </span>celCalc :: (Num a, Fractional a) =&gt; Matrix a -&gt; Matrix a -&gt; Int -&gt; Int -&gt; a
<span class="lineno">   43 </span><span class="decl"><span class="nottickedoff">celCalc a b i j = sum (zipWith (*) (getRow a i 0) (getCol b j 0))</span></span>
<span class="lineno">   44 </span>
<span class="lineno">   45 </span>getRow :: Matrix a -&gt; Int -&gt; Int -&gt; [a]
<span class="lineno">   46 </span><span class="decl"><span class="nottickedoff">getRow m rowNumber index | bound /= index -1 = (arr ! (index,rowNumber)) : getRow m rowNumber (index+1)</span>
<span class="lineno">   47 </span><span class="spaces">                         </span><span class="nottickedoff">| otherwise = []</span>
<span class="lineno">   48 </span><span class="spaces">    </span><span class="nottickedoff">where arr = getArray m</span>
<span class="lineno">   49 </span><span class="spaces">          </span><span class="nottickedoff">(_,(_,bound)) = bounds arr</span></span>
<span class="lineno">   50 </span>
<span class="lineno">   51 </span>getCol :: Matrix a -&gt; Int -&gt; Int -&gt; [a]
<span class="lineno">   52 </span><span class="decl"><span class="nottickedoff">getCol m colNumber index | bound /= index -1 = (arr ! (colNumber,index)) : getCol m colNumber (index+1)</span>
<span class="lineno">   53 </span><span class="spaces">                         </span><span class="nottickedoff">| otherwise = []</span>
<span class="lineno">   54 </span><span class="spaces">    </span><span class="nottickedoff">where arr = getArray m</span>
<span class="lineno">   55 </span><span class="spaces">          </span><span class="nottickedoff">(_,(_,bound)) = bounds arr</span></span>
<span class="lineno">   56 </span>
<span class="lineno">   57 </span>type Column = Int
<span class="lineno">   58 </span>type Row = Int
<span class="lineno">   59 </span>
<span class="lineno">   60 </span>{- 
<span class="lineno">   61 </span>i increments row
<span class="lineno">   62 </span>j increments column
<span class="lineno">   63 </span>-}
<span class="lineno">   64 </span>
<span class="lineno">   65 </span>matrix :: Row -&gt; Column -&gt; ((Row, Column) -&gt; a) -&gt; Matrix a
<span class="lineno">   66 </span><span class="decl"><span class="istickedoff">matrix r c f = Matrix <span class="nottickedoff">r</span> <span class="nottickedoff">c</span> (array ((0,0), (c-1, r-1)) [((i,j), f (i,j)) | j &lt;- [0..r-1], i &lt;- [0..c-1]])</span></span>
<span class="lineno">   67 </span>
<span class="lineno">   68 </span>get :: Matrix a -&gt; (Row, Column) -&gt; a
<span class="lineno">   69 </span><span class="decl"><span class="istickedoff">get m (i,j) = (getArray m) ! (j,i)</span></span>
<span class="lineno">   70 </span>
<span class="lineno">   71 </span>set :: Matrix a -&gt; (Row, Column) -&gt; a -&gt; Matrix a
<span class="lineno">   72 </span><span class="decl"><span class="nottickedoff">set m (i,j) v = Matrix  (getNRows m) (getNCols m) ((getArray m) // [((i, j), v)])</span></span>
<span class="lineno">   73 </span>
<span class="lineno">   74 </span>myM :: Matrix Double
<span class="lineno">   75 </span><span class="decl"><span class="nottickedoff">myM = matrix 4 4 (\(i,j) -&gt; case j of</span>
<span class="lineno">   76 </span><span class="spaces">                                </span><span class="nottickedoff">0 -&gt; fromIntegral i + 1</span>
<span class="lineno">   77 </span><span class="spaces">                                </span><span class="nottickedoff">1 -&gt; fromIntegral i + 5.5</span>
<span class="lineno">   78 </span><span class="spaces">                                </span><span class="nottickedoff">2 -&gt; fromIntegral i + 9</span>
<span class="lineno">   79 </span><span class="spaces">                                </span><span class="nottickedoff">3 -&gt; fromIntegral i + 13.5</span>
<span class="lineno">   80 </span><span class="spaces">                                </span><span class="nottickedoff">_ -&gt; fromIntegral i)</span></span>
<span class="lineno">   81 </span>
<span class="lineno">   82 </span>myM' :: Matrix Double
<span class="lineno">   83 </span><span class="decl"><span class="nottickedoff">myM' = matrix 4 4 (\(i,j) -&gt; fromIntegral i)</span></span>
<span class="lineno">   84 </span>
<span class="lineno">   85 </span>prettyPrint :: (Show a) =&gt; Matrix a -&gt; IO ()
<span class="lineno">   86 </span><span class="decl"><span class="nottickedoff">prettyPrint m = foldMap print (matrixList m)</span></span>
<span class="lineno">   87 </span>
<span class="lineno">   88 </span>matrixList :: (Show a) =&gt; Matrix a -&gt; [[a]]
<span class="lineno">   89 </span><span class="decl"><span class="nottickedoff">matrixList m = (chunkOf (getNCols m) xs)</span>
<span class="lineno">   90 </span><span class="spaces"> </span><span class="nottickedoff">where xs = (horizontalIter (getArray m))</span></span>
<span class="lineno">   91 </span>
<span class="lineno">   92 </span>chunkOf :: Int -&gt; [a] -&gt; [[a]]
<span class="lineno">   93 </span><span class="decl"><span class="istickedoff">chunkOf _ [] = <span class="nottickedoff">[]</span></span>
<span class="lineno">   94 </span><span class="spaces"></span><span class="istickedoff">chunkOf n xs</span>
<span class="lineno">   95 </span><span class="spaces"> </span><span class="istickedoff">| <span class="tickonlytrue">n &gt; 0</span> = (take n xs) : (chunkOf n (drop n xs))</span>
<span class="lineno">   96 </span><span class="spaces"> </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> = <span class="nottickedoff">error &quot;Only positive numbers allowed&quot;</span></span></span>
<span class="lineno">   97 </span>
<span class="lineno">   98 </span>horizontalIter :: Array (Int, Int) a -&gt; [a]
<span class="lineno">   99 </span><span class="decl"><span class="nottickedoff">horizontalIter array = [ array ! (x, y) | y &lt;- [ly.. hy], x &lt;- [lx .. hx]]</span>
<span class="lineno">  100 </span><span class="spaces"> </span><span class="nottickedoff">where ((lx, ly), (hx, hy)) = bounds array</span></span>
<span class="lineno">  101 </span>
<span class="lineno">  102 </span>listToMatrix :: [a] -&gt; Matrix a
<span class="lineno">  103 </span><span class="decl"><span class="istickedoff">listToMatrix xs = matrix bound bound (\(i, j) -&gt; (((chunkOf bound xs) !! j) !! i)) </span>
<span class="lineno">  104 </span><span class="spaces"> </span><span class="istickedoff">where bound = round (sqrt (fromIntegral (length xs)))</span></span>
<span class="lineno">  105 </span>
<span class="lineno">  106 </span>a4 :: Matrix Double
<span class="lineno">  107 </span><span class="decl"><span class="nottickedoff">a4 = listToMatrix [1,2,3,4,5,6,7,8,9,8,7,6,5,4,3,2]</span></span>
<span class="lineno">  108 </span>b4 :: Matrix Double
<span class="lineno">  109 </span><span class="decl"><span class="nottickedoff">b4 = listToMatrix [-2, 1,2 ,3,3,2,1,-1,4,3,6,5,1,2,7,8]</span></span>
<span class="lineno">  110 </span>
<span class="lineno">  111 </span>a3 :: Matrix Double
<span class="lineno">  112 </span><span class="decl"><span class="nottickedoff">a3 = listToMatrix [7,8,9,8,7,6,5,4,3,2]</span></span>
<span class="lineno">  113 </span>
<span class="lineno">  114 </span>b3 :: Matrix Double
<span class="lineno">  115 </span><span class="decl"><span class="nottickedoff">b3 = listToMatrix [-2, -1,-2 ,3,3,2,-1,-1,-4]</span></span>
<span class="lineno">  116 </span>
<span class="lineno">  117 </span>matrixVectorMultiply :: (Num a, Floating a) =&gt; Matrix a -&gt; Tuple a -&gt; Tuple a
<span class="lineno">  118 </span><span class="decl"><span class="nottickedoff">matrixVectorMultiply m t =  listToTuple (map (\row -&gt; dot row t) [ listToTuple (getRow m i 0) | i &lt;- [0..getNCols m -1]])</span></span>
<span class="lineno">  119 </span>
<span class="lineno">  120 </span>listToTuple :: Num a =&gt; [a] -&gt; Tuple a
<span class="lineno">  121 </span><span class="decl"><span class="nottickedoff">listToTuple (x:y:z:w:[]) = tuple x y z w</span></span>
<span class="lineno">  122 </span>
<span class="lineno">  123 </span>
<span class="lineno">  124 </span><span class="decl"><span class="nottickedoff">calc = matrixVectorMultiply a1 b1</span></span>
<span class="lineno">  125 </span>
<span class="lineno">  126 </span><span class="decl"><span class="nottickedoff">a1 = listToMatrix [1,2,3,4,2,4,4,2,8,6,4,1,0,0,0,1]</span></span>
<span class="lineno">  127 </span><span class="decl"><span class="nottickedoff">b1 = listToTuple [1,2,3,1]</span></span>
<span class="lineno">  128 </span>
<span class="lineno">  129 </span>identityMatrix :: Matrix Double
<span class="lineno">  130 </span><span class="decl"><span class="nottickedoff">identityMatrix = matrix 4 4 (\(i,j) -&gt; if i == j then 1.0 else 0.0)</span></span>
<span class="lineno">  131 </span>
<span class="lineno">  132 </span>transpose :: Matrix a -&gt; Matrix a 
<span class="lineno">  133 </span><span class="decl"><span class="nottickedoff">transpose m = matrix (getNRows m) (getNCols m) (\(i,j) -&gt; getArray m ! (j,i))</span></span>
<span class="lineno">  134 </span>
<span class="lineno">  135 </span>determinant :: (Show a, Num a, Fractional a) =&gt; Matrix a -&gt; a
<span class="lineno">  136 </span><span class="decl"><span class="nottickedoff">determinant (Matrix 2 2 array) = (a * d) - (b * c)</span>
<span class="lineno">  137 </span><span class="spaces">    </span><span class="nottickedoff">where a = array ! (0,0)</span>
<span class="lineno">  138 </span><span class="spaces">          </span><span class="nottickedoff">b = array ! (0,1)</span>
<span class="lineno">  139 </span><span class="spaces">          </span><span class="nottickedoff">c = array ! (1,0)</span>
<span class="lineno">  140 </span><span class="spaces">          </span><span class="nottickedoff">d = array ! (1,1)</span>
<span class="lineno">  141 </span><span class="spaces"></span><span class="nottickedoff">determinant m@(Matrix 3 3 array) = a * efhi + b * dfgi + c * degh </span>
<span class="lineno">  142 </span><span class="spaces">    </span><span class="nottickedoff">where efhi = cofactor m 0 0</span>
<span class="lineno">  143 </span><span class="spaces">          </span><span class="nottickedoff">dfgi = cofactor m 0 1</span>
<span class="lineno">  144 </span><span class="spaces">          </span><span class="nottickedoff">degh = cofactor m 0 2</span>
<span class="lineno">  145 </span><span class="spaces">          </span><span class="nottickedoff">a = array ! (0,0)</span>
<span class="lineno">  146 </span><span class="spaces">          </span><span class="nottickedoff">b = array ! (1,0)</span>
<span class="lineno">  147 </span><span class="spaces">          </span><span class="nottickedoff">c = array ! (2,0)</span>
<span class="lineno">  148 </span><span class="spaces"></span><span class="nottickedoff">determinant m@(Matrix 4 4 array) = a * a0 + b * a1 + c * a2 + d * a3</span>
<span class="lineno">  149 </span><span class="spaces">   </span><span class="nottickedoff">where a0 = cofactor m 0 0</span>
<span class="lineno">  150 </span><span class="spaces">         </span><span class="nottickedoff">a1 = cofactor m 0 1</span>
<span class="lineno">  151 </span><span class="spaces">         </span><span class="nottickedoff">a2 = cofactor m 0 2</span>
<span class="lineno">  152 </span><span class="spaces">         </span><span class="nottickedoff">a3 = cofactor m 0 3</span>
<span class="lineno">  153 </span><span class="spaces">         </span><span class="nottickedoff">a = array ! (0,0)</span>
<span class="lineno">  154 </span><span class="spaces">         </span><span class="nottickedoff">b = array ! (1,0)</span>
<span class="lineno">  155 </span><span class="spaces">         </span><span class="nottickedoff">c = array ! (2,0)</span>
<span class="lineno">  156 </span><span class="spaces">         </span><span class="nottickedoff">d = array ! (3,0)</span></span>
<span class="lineno">  157 </span>
<span class="lineno">  158 </span>submatrix :: (Num a, Show a) =&gt; Matrix a -&gt; Row -&gt; Column -&gt; Matrix a
<span class="lineno">  159 </span><span class="decl"><span class="nottickedoff">submatrix m r c = listToMatrix $ concatMap (\x -&gt; take c x ++ drop (1 + c) x) removeRow</span>
<span class="lineno">  160 </span><span class="spaces"> </span><span class="nottickedoff">where removeRow = take r (matrixList m) ++ drop (1 + r) (matrixList m)</span></span>
<span class="lineno">  161 </span>
<span class="lineno">  162 </span>minor :: (Num a,Show a, Fractional a) =&gt; Matrix a -&gt; Row -&gt; Column -&gt; a
<span class="lineno">  163 </span><span class="decl"><span class="nottickedoff">minor m r c = determinant (submatrix m r c)</span></span>
<span class="lineno">  164 </span>
<span class="lineno">  165 </span><span class="decl"><span class="nottickedoff">b = listToMatrix [3,5,0,2,-1,-7,6,-1,5]</span></span>
<span class="lineno">  166 </span>
<span class="lineno">  167 </span>cofactor :: (Num a, Show a, Fractional a)=&gt; Matrix a -&gt; Row -&gt; Column -&gt; a
<span class="lineno">  168 </span><span class="decl"><span class="nottickedoff">cofactor m r c | even (r + c) = minor m r c </span>
<span class="lineno">  169 </span><span class="spaces">                                  </span><span class="nottickedoff">| otherwise = negate (minor m r c)</span></span> 
<span class="lineno">  170 </span>
<span class="lineno">  171 </span>a0 :: Matrix Double
<span class="lineno">  172 </span><span class="decl"><span class="nottickedoff">a0 = listToMatrix [1,2,6,-5,8,-4,2,6,4]</span></span>
<span class="lineno">  173 </span>
<span class="lineno">  174 </span>matrixScalarMultiply :: (Num a,Fractional a) =&gt; Matrix a -&gt; a -&gt; Matrix a
<span class="lineno">  175 </span><span class="decl"><span class="nottickedoff">matrixScalarMultiply m s = Matrix (getNRows m) (getNCols m) (accum (\e a -&gt; a e) (getArray m) [((i,j), (*s)) | j &lt;- [0..getNCols m -1], i &lt;- [0..getNRows m -1]])</span></span>
<span class="lineno">  176 </span>
<span class="lineno">  177 </span>a10 :: Matrix Double
<span class="lineno">  178 </span><span class="decl"><span class="nottickedoff">a10 = listToMatrix [-5,2,6,-8,1,-5,1,8,7,7,-6,-7,1,-3,7,4]</span></span>
<span class="lineno">  179 </span>
<span class="lineno">  180 </span>inverse :: (Num a, Show a, Fractional a) =&gt; Matrix a -&gt; Matrix a
<span class="lineno">  181 </span><span class="decl"><span class="nottickedoff">inverse m = matrix (getNRows m) (getNCols m) (\(i,j) -&gt; (cofactor m i j) / determinant m)</span></span>
<span class="lineno">  182 </span>
<span class="lineno">  183 </span>
<span class="lineno">  184 </span>inverseTest :: Bool
<span class="lineno">  185 </span><span class="decl"><span class="nottickedoff">inverseTest = a4 == a4'</span>
<span class="lineno">  186 </span><span class="spaces">  </span><span class="nottickedoff">where  c4 = a4 * b4</span>
<span class="lineno">  187 </span><span class="spaces">         </span><span class="nottickedoff">a4' = c4 * (inverse b4)</span></span>

</pre>
</body>
</html>
